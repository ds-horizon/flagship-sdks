name: Publish Flagship RN SDK to npm

on:
  push:
    tags:
      - 'rnsdk-v*.*.*' # Triggers on tags like rnsdk-v1.2.3

# Prevent duplicate concurrent runs of the same tag
concurrency:
  group: release-rnsdk-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish Flagship RN SDK to npm

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org/'

      - name: Extract version from Git tag (strip leading 'rnsdk-v' if exists)
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#rnsdk-v}" # removes 'rnsdk-v' prefix if present
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üîñ Release version: $VERSION"

      - name: Validate version format
        run: |
          if [[ ! "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $RELEASE_VERSION"
            exit 1
          fi

      - name: Check if version already exists on npm
        run: |
          cd flagship-rn-sdk
          PACKAGE_NAME=$(jq -r .name package.json)
          echo "Checking package: $PACKAGE_NAME"
          if npm view "$PACKAGE_NAME@$RELEASE_VERSION" > /dev/null 2>&1; then
            echo "‚ùå Version $RELEASE_VERSION already exists on npm."
            exit 1
          fi
          echo "‚úÖ Version $RELEASE_VERSION is available"

      - name: Set package.json version (without git tag)
        run: |
          cd flagship-rn-sdk
          npm version --no-git-tag-version "$RELEASE_VERSION"

      - name: Clean old lib (if exists)
        run: |
          cd flagship-rn-sdk
          if [ -d lib ]; then rm -rf lib; fi

      - name: Install dependencies
        run: |
          cd flagship-rn-sdk
          yarn install --immutable

      - name: Build with bob
        run: |
          cd flagship-rn-sdk
          yarn prepare

      - name: Publish to npm
        run: |
          cd flagship-rn-sdk
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

